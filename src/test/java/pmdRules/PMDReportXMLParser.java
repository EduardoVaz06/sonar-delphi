package pmdRules;

import org.apache.commons.lang.StringUtils;
import org.w3c.dom.*;
import org.xml.sax.SAXException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;

/**
 * Read in a pmd-report.xml file generated by a SonarQube scan
 */
public class PMDReportXMLParser {

    private static String TEST_PROJECT_DIR = "src/test/resources/pmdRuleTestFiles/delphi-test-project/";
    private static String PMD_REPORT_FILE = ".scannerwork/pmd-report.xml";

    public HashMap<String, HashMap<String, ArrayList<String>>> violations = new HashMap<>();
    //private static NamedNodeMap fileNodeList;

    private static void parsePmdReportXML() throws ParserConfigurationException, IOException, SAXException {

        try {
            File pmdReport = new File(TEST_PROJECT_DIR + PMD_REPORT_FILE);
            DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
            DocumentBuilder docBuilder = dbFactory.newDocumentBuilder();
            Document pmdReportDoc = docBuilder.parse(pmdReport);
            pmdReportDoc.getDocumentElement().normalize();

            NodeList violationNodes = pmdReportDoc.getElementsByTagName("violation");

            // tODO move to other function
            for(int i = 0; i < violationNodes.getLength(); i++){

                Node violationNode = violationNodes.item(i);
                Node fileNode = violationNode.getParentNode();

                Element violationElement = (Element) violationNode;
                Element fileElement = (Element) fileNode;

                String pathName = fileElement.getAttribute("name");
                // Strip the full path from the file, just want the name
                String fileName = StringUtils.substringAfterLast(pathName, "\\");

                NamedNodeMap violationList = violationElement.getAttributes();



                System.out.println("");
            }

        } catch (Exception e){
            System.out.print("Error parsing PMD report.\n");
            e.printStackTrace();
        }


    }

    private void buildXMLHashmap(NodeList fileNodes){



    }

    public static void main(String[] args) throws IOException, SAXException, ParserConfigurationException {
        // TODO remove this, just testing
        parsePmdReportXML();
    }


}
